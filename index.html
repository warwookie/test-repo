
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SNEAKERQUEST</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --primary-color: #ff3a2f;
      --secondary-color: #d6c7a4;
      --bg-dark: #0a0a0a;
      --bg-medium: #1a1510;
      --bg-light: #2a2119;
      --wood-light: #b99b66;
      --wood-medium: #876a46;
      --wood-dark: #56432e;
      --screen-bg: #0a241f;
      --led-glow: rgba(255, 58, 47, 0.45);
      --center-cell: 90px; /* shared target width for middle HUD cells (hearts & pause) */
    }

    html, body { display: flex; align-items: flex-start; justify-content: center; overflow: hidden; padding: 0 env(safe-area-inset-right,0) 0 env(safe-area-inset-left,0); background: var(--bg-dark); color: var(--secondary-color); font-family: system-ui, -apple-system, sans-serif; -webkit-user-select: none; user-select: none; min-height: 100dvh; }

    /* bottom-pinned layout (single body rule above) */

    .fixed-container { width: 430px; aspect-ratio: 430 / 900; position: absolute; top: 0; left: 50%; transform-origin: top center; height: auto; max-width: 100vw; margin: 0; }

    .cabinet { width: 100%; height: 100%; border-radius: 28px; padding: 14px; background:
      radial-gradient(120% 120% at 50% 0, #000 0%, #000 18%, transparent 18%),
      linear-gradient(var(--wood-light), #cbb17d 22%, #a98756 22%, #a98756 23%, var(--wood-medium) 23%, var(--wood-medium) 24%, var(--wood-dark) 24%, var(--wood-dark) 25%, #3d3123 25%, #3d3123 100%);
      box-shadow: inset 0 0 0 2px var(--bg-light), 0 24px 40px rgba(0,0,0,.5), 0 6px 0 var(--bg-dark);
    }

    .inner { width: 100%; height: 100%; border-radius: 22px; background: linear-gradient(#6c5640, #3c2f23 14%, #2e251d 14%, #2e251d); box-shadow: inset 0 0 0 2px var(--bg-light), inset 0 0 0 6px var(--bg-medium); position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; gap: 20px; overflow: hidden; }

    /* Marquee section */
    .marquee { width: 100%; height: 90px; border-radius: 18px; padding: 12px 14px; background: linear-gradient(#2a2320, #1d1815); box-shadow: inset 0 0 0 2px #120e0c, inset 0 0 0 6px #2f2722, 0 2px 0 #0a0807; display: flex; align-items: center; justify-content: center; }

    .led { width: 100%; height: 100%; border-radius: 12px; background: radial-gradient(circle at 8px 10px, rgba(255,255,255,.1), transparent 28%), repeating-linear-gradient(180deg, rgba(0,0,0,.4) 0 3px, transparent 3px 10px), #120e0c; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px 10px; position: relative; overflow: hidden; }

    .mq-wrap { display: grid; justify-items: center; align-content: center; height: 100%; }

    .mq-title { font-size: 27px; text-align: center; user-select: none; color: var(--primary-color); text-shadow: 0 0 2px var(--primary-color), 0 0 8px var(--led-glow); animation: led-flicker 3.6s ease-in-out infinite; font-family: 'Press Start 2P', system-ui, -apple-system, sans-serif; }

    .mq-sub { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; font-size: 7px; letter-spacing: .12em; margin-top: 6px; font-family: 'Press Start 2P', system-ui, -apple-system, sans-serif; }
    .mq-sub .chip { white-space: nowrap; }
    .mq-sub .chip-box { padding: 4px 3px; border: 2px solid var(--primary-color); border-radius: 4px; color: var(--primary-color); text-shadow: 0 0 2px var(--primary-color); animation: led-flicker 3.6s ease-in-out infinite; }

    @keyframes led-flicker { 0% { opacity: 0.96; text-shadow: 0 0 2px var(--primary-color), 0 0 6px rgba(255,58,47,.38), 0 0 12px rgba(255,58,47,.2); } 50% { opacity: 1; text-shadow: 0 0 2px var(--primary-color), 0 0 9px rgba(255,58,47,.5), 0 0 16px rgba(255,58,47,.28); } 100% { opacity: 0.97; text-shadow: 0 0 2px var(--primary-color), 0 0 6px rgba(255,58,47,.38), 0 0 12px rgba(255,58,47,.2); } }

    .divider { width: 100%; height: 12px; border-radius: 10px; background: linear-gradient(#3b3026, #2a231e); box-shadow: inset 0 0 0 2px var(--bg-medium); }

    .crt-wrap { width: 100%; height: auto; border-radius: 20px; padding: 10px; background: linear-gradient(#3c2f26, #241e18); box-shadow: inset 0 0 0 2px #1a140f, inset 0 0 0 8px #2a211a; display: flex; align-items: center; justify-content: center; position: relative; }

    .crt { width: 100%; border-radius: 11px; aspect-ratio: 0.94; background: linear-gradient(180deg, rgba(255,255,255,.1), transparent 22%), linear-gradient(var(--screen-bg), #0b2823); box-shadow: inset 0 0 0 2px #0e1412, inset 0 0 30px rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }

    /* Game Canvas */
    #gameCanvas { width: 100%; height: 100%; display: block; border-radius: 11px; image-rendering: pixelated; }

    .tabs { width: 100%; height: 70px; border-radius: 14px; background: linear-gradient(#3a2f26, #2b231d); box-shadow: inset 0 0 0 2px #1a1410; display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; padding: 10px 8px; text-align: center; font-weight: 800; letter-spacing: 0.08em; margin-top: -14px; }

    .tab { display: flex; align-items: stretch; min-width: 0; }

    .tab .led { height: 100%; border-radius: 10px; padding: 8px 10px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; width: 100%; }

    .tab .led .line { font-size: 10px; letter-spacing: .14em; color: var(--primary-color); font-weight: 800; text-shadow: 0 0 2px var(--primary-color); animation: led-flicker 3.6s ease-in-out infinite; font-family: 'Press Start 2P', system-ui, -apple-system, sans-serif; white-space: nowrap; min-width: 0; }

    .hud { width: 100%; display: grid; grid-template-columns: 1fr minmax(auto, var(--center-cell)) 1fr; gap: 3px; margin-top: -16px; }
    .hud .slot-heart{ height: 41px; }
    .hud .slot-shoes{ height: 40px; }
    .hud .slot-dots{ height: 40px; }

    .hud2 { width: 100%; display: grid; grid-template-columns: 1fr minmax(auto, var(--center-cell)) 1fr; gap: 3px; margin-top: -15px; }
    .hud2 .slot-flames{ height: 40px; }

    /* keep the center HUD cells from stretching; center them */
    .slot-shoes, .slot-pause { justify-self: center; max-width: var(--center-cell); width: 100%; }
    .hud2 .slot-bag{ height: 40px; }

    .slot { background: linear-gradient(#3a3227, #2c251e); border-radius: 14px; padding: 5px; box-shadow: inset 0 0 0 2px #1a1511, 0 2px 0 #0b0907; display: flex; align-items: center; justify-content: center; overflow: hidden; height: 100%; width: 100%; }
    .slot > .led { height: 100%; width: 100%; border-radius: 10px; padding: 8px 10px; display: flex; align-items: center; justify-content: center; }
    .slot > .led .line { display: flex; align-items: center; gap: 10px; letter-spacing: .12em; width: 100%; justify-content: center; }

    /* Icon Containers */
    #ui-sneakers, #ui-hearts, #ui-fires, #ui-powers { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 0 4px; box-sizing: border-box; }

    /* Tighter middle-slot spacing */
    .slot-shoes > .led, .slot-pause > .led { padding: 4px 6px; }
    #ui-hearts { gap: 2px; }
    #ui-hearts .heart-outline, #ui-hearts .heart-fill { font-size: 20px; }

    /* Pause button should not force wide box */
    .slot-pause .chip-btn { min-width: auto; letter-spacing: .10em; font-size: 11px; }

    /* Icons */
    #ui-sneakers { gap: 3px; }
    .sneaker-icon { position: relative; display: inline-flex; align-items: center; justify-content: center; }
    .sneaker-outline { color: var(--primary-color); font-size: 20px; filter: drop-shadow(0 0 2px var(--primary-color)); }
    .sneaker-fill { position: absolute; top: 0; left: 0; color: var(--secondary-color); font-size: 20px; opacity: 0; transition: opacity 0.3s ease; }
    .sneaker-icon.active .sneaker-fill { opacity: 1; }

    #ui-hearts { gap: 4px; }
    .heart-icon { position: relative; display: inline-flex; align-items: center; justify-content: center; }
    .heart-outline { color: var(--primary-color); font-size: 20px; filter: drop-shadow(0 0 2px var(--primary-color)); }
    .heart-fill { position: absolute; top: 0; left: 0; color: var(--secondary-color); font-size: 20px; opacity: 0; transition: opacity 0.3s ease; }
    .heart-icon.active .heart-fill { opacity: 1; }

    #ui-fires { gap: 2px; }
    .fire-icon { position: relative; display: inline-flex; align-items: center; justify-content: center; }
    .fire-outline { color: var(--primary-color); font-size: 20px; filter: drop-shadow(0 0 2px var(--primary-color)); }
    .fire-fill { position: absolute; top: 0; left: 0; color: var(--secondary-color); font-size: 20px; opacity: 0; transition: opacity 0.3s ease; }
    .fire-icon.active .fire-fill { opacity: 1; }

    #ui-powers { gap: 7px; }
    .power { position: relative; display: inline-flex; align-items: center; justify-content: center; }
    .power .ph-bold { color: var(--primary-color); font-size: 20px; filter: drop-shadow(0 0 2px var(--primary-color)); }
    .power .ph-fill { position: absolute; top: 0; left: 0; color: var(--secondary-color); font-size: 20px; opacity: 0; transition: opacity 0.3s ease; }
    .power.active .ph-fill { opacity: 1; }

    .chip-btn { background: transparent; border: 0; border-radius: 0; padding: 0; display: grid; place-items: center; color: var(--primary-color); font: inherit; letter-spacing: .12em; cursor: pointer; min-height: 1em; line-height: 1; min-width: 6ch; font-size: 12px; font-family: 'Press Start 2P', system-ui, -apple-system, sans-serif; }
    .chip-btn:focus-visible { outline: none; text-shadow: 0 0 6px var(--primary-color), 0 0 12px rgba(255,58,47,.4); }
    .chip-btn .word { grid-area: 1/1; display: block; text-align: center; opacity: 0; transform: translateY(6%); transition: opacity .24s ease, transform .24s ease; }
    #btn-pause[data-state=playing] .word-pause { opacity: 1; transform: none; }
    #btn-pause[data-state=paused] .word-play { opacity: 1; transform: none; }

    .counter { display: flex; align-items: center; gap: 10px; color: var(--primary-color); text-shadow: 0 0 6px var(--primary-color), 0 0 18px rgba(255,58,47,.45); font-weight: 900; letter-spacing: .14em; }
    .seven { font-family: 'Press Start 2P', ui-monospace, Menlo, Consolas, monospace; font-size: 14px; color: var(--secondary-color); }
    .counter .ph-package { font-size: 20px !important; color: var(--secondary-color) !important; filter: none !important; }

    .bottom { width: 100%; height: 150px; margin-top: -13px; }

    .control-screen { position: relative; height: 100%; border-radius: 18px; padding: 14px; display: grid; grid-template-columns: 82% 20%; gap: 14px; align-items: center; overflow: hidden; background: linear-gradient(#1a1210, #0c0908); box-shadow: inset 0 0 0 2px #1a1510, inset 0 16px 30px rgba(0,0,0,.4), 0 3px 0 #0a0807; }

    .matrix { position: absolute; inset: 6px; border-radius: 14px; opacity: .9; mix-blend-mode: screen; pointer-events: none; background: radial-gradient(circle at center, #140202 40%, #090101 42%, transparent 43%) 0 0 / 10px 10px repeat; }

    @media (max-width: 400px) { 
      .mq-title{font-size:22px;} 
      .mq-sub{font-size:6px;} 
      .tab .led .line{font-size:9px; letter-spacing:.10em; white-space:nowrap;}
    }
    @media (max-width: 390px){
      :root{ --center-cell: 86px; }
      .hud, .hud2{ grid-template-columns: 1fr minmax(auto, var(--center-cell)) 1fr; gap: 2px; }
      #ui-sneakers{gap:2px;} #ui-hearts{gap:2px;} #ui-fires{gap:2px;} #ui-powers{gap:5px;}
      .sneaker-outline, .sneaker-fill,
      .heart-outline,   .heart-fill,
      .fire-outline,    .fire-fill,
      .power .ph-bold,  .power .ph-fill { font-size: 18px; }
      .slot-shoes > .led, .slot-pause > .led { padding: 4px 6px; }
      .tab .led .line{font-size:9px; letter-spacing:.10em;}
    }
    @media (max-width: 360px){
      :root{ --center-cell: 82px; }
      .hud, .hud2{ grid-template-columns: 1fr minmax(auto, var(--center-cell)) 1fr; }
      .tab .led .line{ font-size: 8.5px; letter-spacing: .08em; }
      .sneaker-outline, .sneaker-fill,
      .heart-outline,   .heart-fill,
      .fire-outline,    .fire-fill,
      .power .ph-bold,  .power .ph-fill { font-size: 17px; }
    }
    /* Disable zoom + selection */
  html, body { 
      overscroll-behavior: none;
      -webkit-user-select: none; user-select: none;
      touch-action: none; /* block pinch/pan */
      -ms-touch-action: none;
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
.control-buttons{ position:absolute; top:12px; left:12px; z-index:100; display:flex; flex-direction:column; gap:8px; }
.btn2_temp,.btn2_special,.btn2_timer{ pointer-events:auto; touch-action:manipulation; background:#101012; color:#eaeaea; border:1px solid #3a3a3a; border-radius:10px; padding:8px 12px; font-size:12px; line-height:1; z-index:100; position:relative; font-family: ui-monospace,Consolas,Menlo,monospace; cursor:pointer; }
.btn2_special.active{ background:#2a1010; border-color:#ff2a2a; }
.btn2_timer.active{ background:#102a10; border-color:#2aff2a; }
.btn2-overlay{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:auto; z-index:5; }
#btn2_panel{ position:absolute; inset:0; width:100% !important; height:100% !important; image-rendering:pixelated; display:block; z-index:1; pointer-events:none; }
.btn2_keyproxy{ position:absolute; left:50%; transform:translateX(-50%); width:min(92%, 520px); height:44%; outline:none; border:0; background:transparent; pointer-events:auto; z-index:2; }
#btn2_proxy_blast{ top:6%; }
#btn2_proxy_bomb{ bottom:6%; }
#jpad_canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; }
#jpad_status{ position:absolute; left:12px; bottom:12px; font:12px ui-monospace,Consolas,Menlo,monospace; background:#0008; padding:6px 8px; border-radius:8px; }
</style>
</head>
<body>
  <div class="fixed-container" id="mainContainer">
    <div class="cabinet">
      <div class="inner">
        <div class="marquee" id="element-marquee">
          <div class="led">
            <div class="mq-wrap">
              <div class="line mq-title" id="titleSQ">SNEAKERQUEST</div>
              <div class="line mq-sub">
                <span class="chip chip-stage chip-box">STAGE&nbsp;‚Äì&nbsp;01</span>
                <span class="chip chip-time chip-box">00:00:0</span>
                <span class="chip chip-score chip-box">SCORE&nbsp;000000</span>
              </div>
            </div>
          </div>
        </div>

        <div class="divider" id="element-divider"></div>

        <div class="crt-wrap" id="element-crt">
          <div class="crt">
            <canvas id="gameCanvas"></canvas>
          </div>
        </div>

        <div class="tabs" id="element-tabs">
          <div class="tab"><div class="led"><div class="line">SNEAKERS</div></div></div>
          <div class="tab"><div class="led"><div class="line">LIFE</div></div></div>
          <div class="tab"><div class="led"><div class="line">POWER-UPS</div></div></div>
        </div>

        <div class="hud" id="element-hud1">
          <div class="slot slot-heart"><div class="led"><div class="line" aria-label="Sneakers" id="ui-sneakers"></div></div></div>
          <div class="slot slot-shoes"><div class="led"><div class="line" aria-label="Hearts" id="ui-hearts"></div></div></div>
          <div class="slot slot-dots"><div class="led"><div class="line" aria-label="Powers" id="ui-powers"></div></div></div>
        </div>

        <div class="hud2" id="element-hud2">
          <div class="slot slot-flames"><div class="led"><div class="line" aria-label="Fire" id="ui-fires"></div></div></div>
          <div class="slot slot-pause"><div class="led"><div class="line" aria-label="Pause / Play">
            <button class="chip-btn" id="btn-pause" type="button" aria-pressed="false" aria-label="Pause" data-state="playing">
              <span class="word word-pause" aria-hidden="false">PAUSE</span>
              <span class="word word-play" aria-hidden="true">PLAY</span>
            </button>
          </div></div></div>
          <div class="slot slot-bag"><div class="led"><div class="line counter" aria-label="Box count">
            <i class="ph-fill ph-package" aria-hidden="true"></i>
            <span style="opacity:.8;letter-spacing:.12em">x</span>
            <span class="seven" id="counter">000</span>
          </div></div></div>
        </div>

        <div class="bottom" id="element-bottom">
          <div class="control-screen" id="element-controls">
            <div class="matrix" aria-hidden="true"></div>
            <main class="control-ui" aria-label="Control surface">
              <section class="col-left"><div class="pad"><div class="control-buttons">
  <button id="btn2_temp" class="btn2_temp" aria-label="Start transition">‚ñ∂ special</button>
  <button id="btn2_timer" class="btn2_timer" aria-label="Toggle timer">‚è∞ timer</button>
  <button id="btn2_special" class="btn2_special" aria-label="Toggle special">üîÆ special</button>
</div>
<div class="btn2-overlay">
  <button id="btn2_proxy_blast" class="btn2_keyproxy" role="button" aria-label="Laser" aria-pressed="false" tabindex="0"></button>
  <button id="btn2_proxy_bomb"  class="btn2_keyproxy" role="button" aria-label="Bomb"  aria-pressed="false" tabindex="0"></button>
  <canvas id="btn2_panel" width="560" height="560"></canvas>
</div></div></section>
              <section class="col-right"><div class="pad"><canvas id="jpad_canvas"></canvas>
<output id="jpad_status" aria-live="polite">x 0.00, y 0.00, |v| 0.00, Œ∏ 0.00</output></div></section>
            </main>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === MOBILE SAFARI LAYOUT/SCALING ===
    class MobileSafariLock {
      static initialize() {
        MobileSafariLock.initializeAggressiveScaling();
      }

      static initializeAggressiveScaling() {
        const container = document.querySelector('.fixed-container');
        if (!container) return;

        const applyMeasuredFit = () => {
          const vv = window.visualViewport;
          const vh = vv ? vv.height : window.innerHeight; // visible height (excludes Safari bars)

          // Measure natural height with no transform
          const prev = container.style.transform;
          container.style.transform = 'none';
          const natH = Math.ceil(container.offsetHeight);
          container.style.transform = prev;

          const scale = Math.max(0.01, vh / Math.max(1, natH));
          container.style.transform = `translateX(-50%) scale(${scale})`;
        };

        const schedule = () => requestAnimationFrame(applyMeasuredFit);
        schedule();
        let t;
        window.addEventListener('resize', () => { clearTimeout(t); t = setTimeout(schedule, 80); });
        window.addEventListener('orientationchange', () => setTimeout(schedule, 250));
        window.addEventListener('pageshow', (e) => { if (e.persisted) schedule(); });
        if (window.visualViewport) {
          visualViewport.addEventListener('resize', schedule);
          visualViewport.addEventListener('scroll', schedule);
        }
      }
    }

    // === ICON MANAGER ===
    class IconManager {
      static updateAllIcons() {
        IconManager.renderSneakers(3, 5);
        IconManager.renderHearts(1, 3);
        IconManager.renderPowers(4, 4);
        IconManager.renderFires(4, 5);
      }
      static renderSneakers(fill, outline) {
        const c = document.getElementById('ui-sneakers'); if (!c) return; c.innerHTML = '';
        for (let i = 0; i < outline; i++) c.innerHTML += `
          <div class="sneaker-icon ${i < fill ? 'active' : ''}">
            <i class="ph-bold ph-sneaker sneaker-outline" aria-hidden="true"></i>
            <i class="ph-fill ph-sneaker sneaker-fill" aria-hidden="true"></i>
          </div>`;
      }
      static renderHearts(fill, outline) {
        const c = document.getElementById('ui-hearts'); if (!c) return; c.innerHTML = '';
        for (let i = 0; i < outline; i++) c.innerHTML += `
          <div class="heart-icon ${i < fill ? 'active' : ''}">
            <i class="ph-bold ph-heart heart-outline" aria-hidden="true"></i>
            <i class="ph-fill ph-heart heart-fill" aria-hidden="true"></i>
          </div>`;
      }
      static renderFires(fill, outline) {
        const c = document.getElementById('ui-fires'); if (!c) return; c.innerHTML = '';
        for (let i = 0; i < outline; i++) c.innerHTML += `
          <div class="fire-icon ${i < fill ? 'active' : ''}">
            <i class="ph-bold ph-fire fire-outline" aria-hidden="true"></i>
            <i class="ph-fill ph-fire fire-fill" aria-hidden="true"></i>
          </div>`;
      }
      static renderPowers(total, fill) {
        const c = document.getElementById('ui-powers'); if (!c) return; c.innerHTML = '';
        const types = [ { b:'ph-timer', f:'ph-timer' }, { b:'ph-shield', f:'ph-shield' }, { b:'ph-magnet', f:'ph-magnet' }, { b:'ph-crosshair-simple', f:'ph-crosshair-simple' } ];
        for (let i = 0; i < total; i++) {
          const t = types[i % types.length];
          c.innerHTML += `
            <div class="power ${i < fill ? 'active' : ''}">
              <i class="ph-bold ${t.b}" aria-hidden="true"></i>
              <i class="ph-fill ${t.f}" aria-hidden="true"></i>
            </div>`;
        }
      }
    }

    // === GAME SETUP ===
    function setupSimpleGame() {
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');

      function resizeCanvas() {
        const crt = document.querySelector('.crt');
        const cssW = crt.clientWidth;  const cssH = crt.clientHeight;

        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';

        const dpr = window.devicePixelRatio || 1;
        canvas.width  = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        draw();

        // Self-tests
        console.assert(Math.abs(canvas.width  / (window.devicePixelRatio||1) - cssW) < 1, 'Canvas width backing store mismatch');
        console.assert(Math.abs(canvas.height / (window.devicePixelRatio||1) - cssH) < 1, 'Canvas height backing store mismatch');
      }

      function draw() {
        const w = canvas.clientWidth; const h = canvas.clientHeight;
        ctx.fillStyle = '#0a241f'; ctx.fillRect(0, 0, w, h);
        ctx.fillStyle = '#d6c7a4'; ctx.font = '20px "Press Start 2P"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('SNEAKER BOMBER', w / 2, h / 2 - 20);
        ctx.fillText('SPACE TO START', w / 2, h / 2 + 20);
      }

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
    }

    document.addEventListener('DOMContentLoaded', () => {
      MobileSafariLock.initialize();
      IconManager.updateAllIcons();
      setupSimpleGame();
      const pauseBtn = document.getElementById('btn-pause');
      if (pauseBtn) pauseBtn.addEventListener('click', function(){ this.dataset.state = this.dataset.state === 'playing' ? 'paused' : 'playing'; });
      setTimeout(() => { window.scrollTo(0, 0); }, 120);
    });

    // Simple UI API
    window.SneakerQuestUI = {
      IconManager,
      setSneakers: (f, t) => IconManager.renderSneakers(f, t),
      setHearts:   (f, t) => IconManager.renderHearts(f, t),
      setPowers:   (f, t) => IconManager.renderPowers(t, f),
      setFires:    (f, t) => IconManager.renderFires(f, t),
      setCounter:  (v) => { const el = document.getElementById('counter'); if (el) el.textContent = String(v).padStart(3, '0'); },
      setStage:    (s) => { const el = document.querySelector('.chip-stage'); if (el) el.textContent = `STAGE ‚Äì ${String(s).padStart(2, '0')}`; },
      setScore:    (v) => { const el = document.querySelector('.chip-score'); if (el) el.textContent = `SCORE ${String(v).padStart(6, '0')}`; },
      setTime:     (t) => { const el = document.querySelector('.chip-time');  if (el) el.textContent = t; }
    };
      // === HARD LOCK: disable zooming (pinch, double-tap, ctrl+wheel) ===
    (function lockPageZoom(){
        const opts = { passive: false };
        ['gesturestart','gesturechange','gestureend'].forEach(type=>
            document.addEventListener(type, e=>e.preventDefault(), opts)
        );
        // Block double‚Äëtap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e=>{
            const now = Date.now();
            if (now - lastTouchEnd <= 350) e.preventDefault();
            lastTouchEnd = now;
        }, opts);
        // Block ctrl+wheel zoom (desktop)
        document.addEventListener('wheel', e=>{ if (e.ctrlKey) e.preventDefault(); }, opts);
        // iOS focus zoom workaround not needed (no inputs <16px)
    })();
</script>
<script>
document.addEventListener('touchmove', (e)=>{ if(e.target.closest('.col-left, .col-right')) e.preventDefault(); },{passive:false});
(() => {
  const DEADZONE=0.15, RESPONSE=1.20, SMOOTH=0.22, AUTO_RETURN=true;
  let PITCH=10, DOT_R=2.6; const LEVELS=[0,0.35,0.65,1];
  const RED='#ff2a2a', MID='#ff2a2acc', DIM='#ff2a2a66', OFF='#210000';
  const DECAY=0.90; let buf; const KNOB_CORE=0.10, KNOB_GLOWR=0.30, STEM_GAIN=0.80;
  window.jpad_state={ x:0, y:0, mag:0, angle:0, trigger:false, bomb:false };
  const cvs=document.getElementById('jpad_canvas'); if(!cvs){return;} const ctx=cvs.getContext('2d');
  const readout=document.getElementById('jpad_status'); const rightArea=document.querySelector('.col-right');
  let W=0,H=0,COLS=0,ROWS=0,OX=0,OY=0, joyCX=0,joyCY=0,joyR=0; let layoutReady=false;
  let outX=0,outY=0, joyTX=0,joyTY=0; const activePointers=new Map();
  function updateLayout(newWidth,newHeight){ if(newWidth<1||newHeight<1) return; cvs.width=newWidth; cvs.height=newHeight; W=newWidth; H=newHeight;
    const targetRows=24; PITCH=H/targetRows; DOT_R=PITCH*0.21; COLS=Math.floor(W/PITCH); ROWS=Math.floor(H/PITCH); if(COLS<1||ROWS<1) return;
    OX=(W-COLS*PITCH)/2 + PITCH/2; OY=(H-ROWS*PITCH)/2 + PITCH/2; joyCX=W*0.5; joyCY=H*0.5; joyR=(Math.min(W,H)/2)-(PITCH*3); buf=new Float32Array(COLS*ROWS); layoutReady=true; }
  function getPointerLocation(e){ const r=cvs.getBoundingClientRect(); return {x:e.clientX-r.left, y:e.clientY-r.top}; }
  function joyPointerToNorm(x,y){ const dx=x-joyCX, dy=y-joyCY; const dist=Math.hypot(dx,dy), ang=Math.atan2(dy,dx); let rn=Math.min(dist/joyR,1);
    if(rn<DEADZONE) rn=0; else rn=(rn-DEADZONE)/(1-DEADZONE); rn=Math.pow(rn,RESPONSE); return { nx:Math.cos(ang)*rn, ny:Math.sin(ang)*rn }; }
  cvs&&cvs.addEventListener('pointerdown', e=>{ e.preventDefault(); const {x,y}=getPointerLocation(e); try{ cvs.setPointerCapture(e.pointerId);}catch(_){}
    activePointers.set(e.pointerId,'joy'); const v=joyPointerToNorm(x,y); joyTX=v.nx; joyTY=v.ny; });
  cvs&&cvs.addEventListener('pointermove', e=>{ e.preventDefault(); if(activePointers.get(e.pointerId)!=='joy') return; const {x,y}=getPointerLocation(e); const v=joyPointerToNorm(x,y); joyTX=v.nx; joyTY=v.ny; });
  function endPointer(e){ const t=activePointers.get(e.pointerId); activePointers.delete(e.pointerId); if(t==='joy'){ let any=false; for(const v of activePointers.values()) if(v==='joy') any=true; if(!any && AUTO_RETURN){ joyTX=0; joyTY=0; } } }
  cvs&&cvs.addEventListener('pointerup', endPointer); cvs&&cvs.addEventListener('pointercancel', endPointer); cvs&&cvs.addEventListener('pointerleave', endPointer);
  function loop(){ outX+=(joyTX-outX)*SMOOTH; outY+=(joyTY-outY)*SMOOTH; drawDMD(outX,outY); window.jpad_state.x=outX; window.jpad_state.y=outY; window.jpad_state.mag=Math.min(Math.hypot(outX,outY),1); window.jpad_state.angle=Math.atan2(outY,outX);
    if(readout) readout.value = `x ${outX.toFixed(2)}, y ${outY.toFixed(2)}, |v| ${window.jpad_state.mag.toFixed(2)}, Œ∏ ${window.jpad_state.angle.toFixed(2)}`; requestAnimationFrame(loop); }
  function drawDMD(nx,ny){ if(!layoutReady){ if(ctx) ctx.clearRect(0,0,W,H); return; } ctx.clearRect(0,0,W,H);
    const now=performance.now()*0.001; const px=joyCX+nx*joyR, py=joyCY+ny*joyR;
    for(let j=0;j<ROWS;j++){ for(let i=0;i<COLS;i++){ const idx=j*COLS+i; buf[idx]=(buf[idx]||0)*DECAY; } }
    const ringThick=PITCH*0.75, dzRingThick=PITCH*0.5, t=now*1.6, sweepArcLength=Math.PI/3;
    for(let j=0;j<ROWS;j++){ for(let i=0;i<COLS;i++){ const x=OX+i*PITCH, y=OY+j*PITCH; const idx=j*COLS+i; const jdx=x-joyCX, jdy=y-joyCY;
      const jd=Math.hypot(jdx,jdy), jang=Math.atan2(jdy,jdx);
      buf[idx]+=max0(1-mabs(jd-joyR*0.25)/(ringThick*0.5))*0.22;
      buf[idx]+=max0(1-mabs(jd-joyR*0.50)/(ringThick*0.5))*0.20;
      buf[idx]+=max0(1-mabs(jd-joyR*0.75)/(ringThick*0.5))*0.18;
      buf[idx]+=max0(1-mabs(jd-joyR*1.00)/(ringThick*0.5))*0.16;
      buf[idx]+=max0(1-mabs(jd-joyR*0.15)/(dzRingThick*0.5))*0.12;
      const da=(t-jang)%(Math.PI*2); if(da>0 && da<sweepArcLength) buf[idx]+=0.9;
      let b=buf[idx]||0; b*=1 - clamp01((Math.hypot(x-W/2,y-H/2)/(Math.min(W,H)/2) - 0.96) / 0.16);
      const levels=[0,0.35,0.65,1]; let best=0,bd=1e9; for(const s of levels){ const d=Math.abs(b-s); if(d<bd){ bd=d; best=s; } }
      const color= best>=1?RED:(best>=0.65?MID:DIM);
      ctx.save(); ctx.shadowColor=color; ctx.shadowBlur=8*best; ctx.beginPath(); ctx.arc(x,y,DOT_R,0,2*Math.PI); ctx.fillStyle=best>0?color:OFF; ctx.fill(); ctx.restore();
    }} }
  const max0=(x)=>Math.max(0,x); const mabs=Math.abs; const clamp01=(t)=>Math.min(1,Math.max(0,t));
  const ro=new ResizeObserver(entries=>{ if(entries[0]){ const {width,height}=entries[0].contentRect; const p=parseFloat(getComputedStyle(rightArea).getPropertyValue('--gap'))||16; const w=Math.max(1, Math.floor(width - p*2)); const h=Math.max(1, Math.floor(height - p*2)); updateLayout(w,h);} });
  if(rightArea) ro.observe(rightArea); requestAnimationFrame(loop);
})();

/* Buttons + Bomb/Laser (v14 + X-lock) */
(() => {
(async function(){
  const p=4, d=0.46*p; const W=560, H=560; const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const canvas=document.getElementById('btn2_panel'); if(!canvas){return;} const DPR=clamp(Math.round(devicePixelRatio||1),1,2);
  canvas.width=W*DPR; canvas.height=H*DPR; canvas.style.width=W+'px'; canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d'); ctx.scale(DPR,DPR);
  const nowS=()=>performance.now()/1000; const snap=v=>Math.round(v/p)*p;
  const easeInOut=t=> (t<0.5? 2*t*t : 1 - Math.pow(-2*t+2,2)/2), easeOutCubic=t=>1-Math.pow(1-t,3), easeInCubic=t=>t*t*t, easeOutExpo=t=> (t===1?1:1-Math.pow(2,-10*t)), easeOutBack=t=>{ const c1=1.70158, c3=c1+1; return 1 + c3*Math.pow(t-1,3) + c1*Math.pow(t-1,2); };
  const col={ bright:'rgba(255,58,58,1.0)' };
  function drawBrightDotFast(c,x,y,a=1){ if(a<=0)return; c.save(); c.globalAlpha=a; c.fillStyle=col.bright; c.beginPath(); c.arc(x,y,d*0.66,0,Math.PI*2); c.fill(); c.restore(); }
  function brightDotGradient(c,x,y){ const r2=2*d; const g=c.createRadialGradient(x,y,0,x,y,r2); const r=255,gc=58,b=58; const tp=k=>clamp(k*(d/r2),0,1); g.addColorStop(0,`rgba(${r},${gc},${b},1)`); g.addColorStop(tp(0.42),`rgba(${r},${gc},${b},1)`); g.addColorStop(tp(0.75),`rgba(${r},${gc},${b},0.60)`); g.addColorStop(tp(1.30),`rgba(${r},${gc},${b},0.18)`); g.addColorStop(1,`rgba(${r},${gc},${b},0)`); return g; }
  function drawBrightDot(c,x,y,a=1){ if(a<=0) return; c.save(); c.globalAlpha=a; c.fillStyle=brightDotGradient(c,x,y); c.beginPath(); c.arc(x,y,d,0,Math.PI*2); c.fill(); c.restore(); }
  function rrPath(c,r){ c.beginPath(); c.moveTo(r.x+r.r,r.y); c.lineTo(r.x+r.w-r.r,r.y); c.arcTo(r.x+r.w,r.y,r.x+r.w,r.y+r.r,r.r); c.lineTo(r.x+r.w,r.y+r.h-r.r); c.arcTo(r.x+r.w,r.y+r.h,r.x+r.w-r.r,r.y+r.h,r.r); c.lineTo(r.x+r.r,r.y+r.h); c.arcTo(r.x,r.y+r.h,r.x,r.y+r.h-r.r,r.r); c.lineTo(r.x,r.y+r.r); c.arcTo(r.x,r.y,r.x+r.r,r.y,r.r); c.closePath(); }
  function path2DFor(r){ const p2=new Path2D(); p2.moveTo(r.x+r.r,r.y); p2.lineTo(r.x+r.w-r.r,r.y); p2.arcTo(r.x+r.w,r.y,r.x+r.w,r.y+r.r,r.r); p2.lineTo(r.x+r.w,r.y+r.h-r.r); p2.arcTo(r.x+r.w,r.y+r.h,r.x+r.w-r.r,r.y+r.h,r.r); p2.lineTo(r.x+r.r,r.y+r.h); p2.arcTo(r.x,r.y+r.h,r.x,r.y+r.h-r.r,r.r); p2.lineTo(r.x,r.y+r.r); p2.arcTo(r.x,r.y,r.x+r.r,r.y,r.r); p2.closePath(); return p2; }
  function dedupe(pts,tol){ const out=[]; for(const a of pts){ let ok=true; for(const b of out){ const dx=a.x-b.x,dy=a.y-b.y; if(dx*dx+dy*dy<tol*tol){ ok=false; break; } } if(ok) out.push(a); } return out; }
  function sampleRoundedRectDots(x,y,w,h,r){ const pts=[]; const step=p; const add=(X,Y)=>pts.push({x:snap(X),y:snap(Y)}); for(let X=x+r; X<=x+w-r; X+=step){ add(X,y); add(X,y+h); } for(let Y=y+r; Y<=y+h-r; Y+=step){ add(x,Y); add(x+w,Y); } const arc=(cx,cy,t0,t1)=>{ const thetaStep=step/r; const inc=t1>=t0?thetaStep:-thetaStep; for(let t=t0; inc>0? t<=t1 : t>=t1; t+=inc){ add(cx+r*Math.cos(t), cy+r*Math.sin(t)); } }; arc(x+r,y+r,Math.PI,1.5*Math.PI); arc(x+w-r,y+r,1.5*Math.PI,2*Math.PI); arc(x+w-r,y+h-r,0,0.5*Math.PI); arc(x+r,y+h-r,0.5*Math.PI,Math.PI); return dedupe(pts,0.35*p); }
  function drawDottedRR(c, r){ const pts=sampleRoundedRectDots(r.x,r.y,r.w,r.h,r.r); for(const pt of pts) drawBrightDot(c,pt.x,pt.y); const off=document.createElement('canvas'); off.width=W; off.height=H; const o=off.getContext('2d'); for(const pt of pts) drawBrightDot(o,pt.x,pt.y); c.save(); c.globalAlpha=0.35; c.filter=`blur(${3*p}px)`; c.drawImage(off,0,0); c.restore(); c.save(); c.globalAlpha=0.12; c.filter=`blur(${8*p}px)`; c.drawImage(off,0,0); c.restore(); }
  function drawInnerBandRR(c, r, rows=3){ const b_in=2.8*p; const mid=(rows-1)/2; let innerMost=null; const off=document.createElement('canvas'); off.width=W; off.height=H; const o=off.getContext('2d');
    for(let i=0;i<rows;i++){ const oset=b_in+(i-mid)*p; const x=r.x+oset,y=r.y+oset,w=r.w-2*oset,h=r.h-2*oset,rad=r.r-oset; const pts=sampleRoundedRectDots(x,y,w,h,rad);
      for(const pt of pts) drawBrightDot(c,pt.x,pt.y,0.70); for(const pt of pts) drawBrightDot(o,pt.x,pt.y); innerMost={x,y,w,h,r:rad}; }
    c.save(); c.globalAlpha=0.25; c.filter=`blur(${2*p}px)`; c.drawImage(off,0,0); c.restore(); const pad=1*p; return {x:innerMost.x+pad,y:innerMost.y+pad,w:innerMost.w-2*pad,h:innerMost.h-2*pad,r:innerMost.r-pad}; }
  const bg=document.createElement('canvas'); bg.width=W; bg.height=H; const bgc=bg.getContext('2d');
  function drawIdleGrid(c){ for(let y=0;y<=H;y+=p){ for(let x=0;x<=W;x+=p){ c.fillStyle='#1A0E0E'; c.beginPath(); c.arc(x,y,d*0.5,0,2*Math.PI); c.fill(); } } }
  function drawPerimeter(c){ const inset=3*p, rr=10*p; drawDottedRR(c,{x:inset,y:inset,w:W-2*inset,h:H-2*inset,r:rr}); }
  drawIdleGrid(bgc); drawPerimeter(bgc);
  const gap=14*p, rad=6*p; const Bw=W-2*gap; const Bh=Math.round((H-3*gap)/2/p)*p; const x_btn=gap; const yTop=gap; const yBot=yTop+Bh+gap;
  const centerOuter={x:gap, y:snap((H-Bh)/2), w:Bw, h:Bh, r:rad};
  const topOuter   ={x:x_btn, y:yTop, w:Bw, h:Bh, r:rad};
  const botOuter   ={x:x_btn, y:yBot, w:Bw, h:Bh, r:rad};
  const layerSingle=document.createElement('canvas'); layerSingle.width=W; layerSingle.height=H; const ls=layerSingle.getContext('2d');
  const layerTwo=document.createElement('canvas'); layerTwo.width=W; layerTwo.height=H; const lt=layerTwo.getContext('2d');
  drawDottedRR(ls, centerOuter); const faceBOMB_center = drawInnerBandRR(ls, centerOuter, 3);
  drawDottedRR(lt, topOuter);    const faceLASER_final = drawInnerBandRR(lt, topOuter, 3);
  drawDottedRR(lt, botOuter);    const faceBOMB_final  = drawInnerBandRR(lt, botOuter, 3);
  const FONT='Press Start 2P'; await document.fonts.load(`32px '${FONT}'`); await document.fonts.ready;
  function pickFontPx(rect){ const maxPx=64,minPx=16; for(let px=maxPx; px>=minPx; px-=8){ if(px+4<=rect.h) return px; } return minPx; }
  function measureTextWidth(text,px){ const off=document.createElement('canvas'); const c=off.getContext('2d'); c.font=`${px}px '${FONT}'`; c.textBaseline='top'; let w=0; for(const ch of text){ w+=c.measureText(ch).width; } return Math.ceil(w); }
  function rasterTextPoints(rect,text){ const px=pickFontPx(rect), pad=2; const off=document.createElement('canvas'); const o=off.getContext('2d'); o.font=`${px}px '${FONT}'`; o.textBaseline='top'; o.imageSmoothingEnabled=false; o.fillStyle='#fff';
    const w=Math.ceil(measureTextWidth(text,px)); const h=Math.ceil(px*1.0); off.width=w+pad*2; off.height=h+pad*2; o.font=`${px}px '${FONT}'`; o.textBaseline='top'; o.fillStyle='#fff'; o.clearRect(0,0,off.width,off.height); o.fillText(text,pad,pad);
    const dx=snap(rect.x+(rect.w-off.width)/2), dy=snap(rect.y+(rect.h-off.height)/2); const img=o.getImageData(0,0,off.width,off.height); const iw=off.width, ih=off.height; const thr=4;
    function alpha(ix,iy){ if(ix<0||iy<0||ix>=iw||iy>=ih) return 0; return img.data[((iy|0)*iw+(ix|0))*4+3]|0; }
    const pts=[]; for(let gy=dy; gy<dy+ih; gy+=p){ for(let gx=dx; gx<dx+iw; gx+=p){ const ix=gx-dx, iy=gy-dy; let a=0; const offs=[0,p*0.33,p*0.66]; for(const oy of offs){ for(const ox of offs){ a=Math.max(a,alpha(ix+ox,iy+oy)); } } if(a>thr){ pts.push({x:gx,y:gy}); } } } return pts; }
  function getBombText(){ return 'BOMB X'; } function getLaserText(){ return 'LASER'; }
  let bombWordDotsFinal  = rasterTextPoints(faceBOMB_final,  getBombText());
  let bombWordDotsCenter = rasterTextPoints(faceBOMB_center, getBombText());
  let laserWordDotsFinal = rasterTextPoints(faceLASER_final, getLaserText());
  const state = { mode: 'single', active: false, t0: 0, activeReverse:false, t0r:0, laserAmmo: 4, maxAmmo: 4, specialActive: false, timerPowerup: false, bombDeployed: false, bombArmed: false,
    bombMorph: { active: false, phase: 'idle', progress: 0, startTime: 0, duration: 900, bombType: 'center', pairs: [], extras: [], meta: [], blastSeed: 0, autoExplode:false } };
  function buildFaceMask(rect){ const pts=[]; const off=document.createElement('canvas'); off.width=W; off.height=H; const oc=off.getContext('2d'); rrPath(oc, rect);
    const isIn=(x,y)=>oc.isPointInPath(x+0.01,y+0.01); for(let y=rect.y; y<=rect.y+rect.h; y+=p){ for(let x=rect.x; x<=rect.x+rect.w; x+=p){ const X=snap(x), Y=snap(y); if(isIn(X,Y)) pts.push({x:X,y:Y}); } }
    const perim = sampleRoundedRectDots(rect.x,rect.y,rect.w,rect.h,rect.r); function nearPerim(x,y){ for(const q of perim){ const dx=x-q.x, dy=y-q.y; if(dx*dx+dy*dy <= (p*1.5)*(p*1.5)) return true; } return false; }
    for(const pt of pts){ pt.perim = nearPerim(pt.x, pt.y); } return {pts, perim}; }
  const maskLASER = buildFaceMask(faceLASER_final); const maskBOMB_bottom  = buildFaceMask(faceBOMB_final); const maskBOMB_centerM  = buildFaceMask(faceBOMB_center);
  function withPolar(mask, cx, cy){ return mask.pts.map(pt=>({x:pt.x,y:pt.y, perim:pt.perim, d:Math.hypot(pt.x-cx, pt.y-cy), a:Math.atan2(pt.y-cy, pt.x-cx)})); }
  const cLaser = {x:snap(faceLASER_final.x+faceLASER_final.w/2), y:snap(faceLASER_final.y+faceLASER_final.h/2)};
  const cBombB = {x:snap(faceBOMB_final.x+faceBOMB_final.w/2),   y:snap(faceBOMB_final.y+faceBOMB_final.h/2)};
  const cBombC = {x:snap(faceBOMB_center.x+faceBOMB_center.w/2), y:snap(faceBOMB_center.y+faceBOMB_center.h/2)};
  const laserDots = withPolar(maskLASER, cLaser.x, cLaser.y); const bombDotsB = withPolar(maskBOMB_bottom, cBombB.x, cBombB.y); const bombDotsC = withPolar(maskBOMB_centerM, cBombC.x, cBombC.y);
  function getLaserSectionRects(faceRect) { const sections = 4, sectionHeight = faceRect.h / sections, rects = []; for (let i = 0; i < sections; i++) rects.push({ x: faceRect.x, y: faceRect.y + i * sectionHeight, w: faceRect.w, h: sectionHeight, r: faceRect.r }); return rects; }
  function buildMask(rect){ return buildFaceMask(rect); }
  const laserSectionMasks = getLaserSectionRects(faceLASER_final).map(buildMask);
  function groupRowsTopDown(...lists){ const rows=new Map(); for(const list of lists){ for(const pt of list){ const y=pt.y; if(!rows.has(y)) rows.set(y,[]); rows.get(y).push(pt); } } const ys=[...rows.keys()].sort((a,b)=>a-b);
    return ys.map(y=>({ y, pts: rows.get(y).sort((a,b)=>a.x-b.x), n: rows.get(y).length })); }
  const laserOuterPts = sampleRoundedRectDots(faceLASER_final.x,faceLASER_final.y,faceLASER_final.w,faceLASER_final.h,faceLASER_final.r);
  const laserInnerBandPts = (function(){ const rows=3, b_in=2.8*p; const mid=(rows-1)/2; const acc=[]; for(let i=0;i<rows;i++){ const o=b_in+(i-mid)*p; const x=faceLASER_final.x+o, y=faceLASER_final.y+o, w=faceLASER_final.w-2*o, h=faceLASER_final.h-2*o, r=faceLASER_final.r-o; const pts=sampleRoundedRectDots(x,y,w,h,r); for(const pt of pts) acc.push(pt); } return acc; })();
  const laserRows = groupRowsTopDown(laserOuterPts, laserInnerBandPts, rasterTextPoints(faceLASER_final,'LASER'));
  const laserRowImgs = laserRows.map(row => { const off=document.createElement('canvas'); off.width=W; off.height=H; const o=off.getContext('2d'); for(const pt of row.pts) drawBrightDot(o,pt.x,pt.y,0.94); return off; });
  function sortByAngleThenRadius(center, arr){ return arr.map(pt=>{ const dx=pt.x-center.x, dy=pt.y-center.y; return {pt, a:Math.atan2(dy,dx), r:Math.hypot(dx,dy)}; }).sort((u,v)=> u.a===v.a ? u.r-v.r : u.a-v.a).map(o=>o.pt); }
  function buildDiskForCount(center, faceRect, N){ const maxR = Math.min(faceRect.w, faceRect.h) * 0.40; const pts=[]; const seen=new Set(); const stepR = p*0.9;
    for(let rr=0; rr<=maxR && pts.length<N; rr+=stepR){ const stepAng = (rr<=p? Math.PI/6 : Math.max(p/(rr or 1), 0.05));  # noqa
      for(let ang=0; ang<Math.PI*2 && pts.length<N; ang+=stepAng){ const x = snap(center.x + rr*Math.cos(ang)); const y = snap(center.y + rr*Math.sin(ang));
        if (x>=faceRect.x && x<=faceRect.x+faceRect.w && y>=faceRect.y && y<=faceRect.y+faceRect.h){ const key=x+','+y; if(!seen.has(key)){ seen.add(key); pts.push({x,y}); } } } }
    if (pts.length<N){ for(let ang=0; ang<Math.PI*2 && pts.length<N; ang+=Math.PI/128){ const x = snap(center.x + maxR*Math.cos(ang)); const y = snap(center.y + maxR*Math.sin(ang));
      const key=x+','+y; if(!seen.has(key)){ seen.add(key); pts.push({x,y}); } } } return sortByAngleThenRadius(center, pts).slice(0,N); }
  function buildInnerRing(center, faceRect, count){ if (count<=0) return []; const R = Math.min(faceRect.w, faceRect.h) * 0.22; const pts=[]; const seen=new Set();
    for(let i=0;i<count;i++){ const ang = i*(Math.PI*2/count); const x = snap(center.x + R*Math.cos(ang)); const y = snap(center.y + R*Math.sin(ang));
      if (x>=faceRect.x && x<=faceRect.x+faceRect.w && y>=faceRect.y && y<=faceRect.y+faceRect.h){ const key=x+','+y; if(!seen.has(key)){ seen.add(key); pts.push({x,y}); } } } return sortByAngleThenRadius(center, pts); }
  def_buildPairs = (lambda center, src, dst: [{'sx':s['x'],'sy':s['y'],'dx':d['x'],'dy':d['y']} for s,d in zip(src, dst)])  # placeholder for readability
</script>
</body>
</html>
