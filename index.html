import React, { useEffect, useRef, useState } from "react";

// SneakerQuest Retro-Futuristic v2 Canvas ‚Äî DRAG + RESIZE + Export/Import + Undo/Redo + Snap Toggle
// All visual chrome preserved. All elements editable. Info bar now uses its own editable state.

const SNAP = 8;
const hardSnap = (n: number) => Math.round(n / SNAP) * SNAP;

type Box = { x: number; y: number; w: number; h: number };

type HudConfig = {
  label: string;
  icon: string;
  count: number;        // emoji repeat count
  font: number;         // label font px
  iconSize: number;     // icon font px
  showCount: boolean;   // show separate count text
  countText: string;    // e.g. "x 5" or "x 0000"
  // Absolute positioning inside the box (px from top-left)
  textX: number; textY: number;
  iconX: number; iconY: number;
  countX: number; countY: number;
};

// Info bar editable content
type InfoConfig = {
  stageLeft: string;   // e.g., "STAGE ‚Äî ONE"
  chevron: string;     // e.g., "‚ñ∏"
  timer: string;       // e.g., "00:00:00:0"
  scoreLabel: string;  // e.g., "SCORE"
  score: string;       // e.g., "000000"
  font: number;        // main font size
  subFont: number;     // score subline font size
};

function useDrag(
  pos: { x: number; y: number },
  setPos: (p: { x: number; y: number }) => void,
  snapper: (n: number) => number,
  onStart?: () => void
) {
  const dragging = useRef(false);
  useEffect(() => {
    const onMove = (e: MouseEvent) => {
      if (!dragging.current) return;
      setPos({ x: snapper(pos.x + e.movementX), y: snapper(pos.y + e.movementY) });
    };
    const onUp = () => { dragging.current = false; };
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);
    return () => { window.removeEventListener("mousemove", onMove); window.removeEventListener("mouseup", onUp); };
  }, [pos.x, pos.y, setPos, snapper]);
  const onMouseDown = () => { if (!dragging.current) onStart && onStart(); dragging.current = true; };
  return { onMouseDown };
}

function useResize(
  box: { w: number; h: number; x: number; y: number },
  setBox: (b: { w: number; h: number; x: number; y: number }) => void,
  snapper: (n: number) => number,
  onStart?: () => void
) {
  const mode = useRef<null | { h: string }>(null);
  useEffect(() => {
    const onMove = (e: MouseEvent) => {
      if (!mode.current) return;
      const handle = mode.current.h as "nw" | "n" | "ne" | "e" | "se" | "s" | "sw" | "w";
      let { x, y, w, h } = box;
      const dx = e.movementX, dy = e.movementY;
      if (handle.includes("n")) { y = snapper(y + dy); h = snapper(h - dy); }
      if (handle.includes("s")) { h = snapper(h + dy); }
      if (handle.includes("w")) { x = snapper(x + dx); w = snapper(w - dx); }
      if (handle.includes("e")) { w = snapper(w + dx); }
      w = Math.max(40, w); h = Math.max(24, h);
      setBox({ x, y, w, h });
    };
    const onUp = () => { mode.current = null; };
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);
    return () => { window.removeEventListener("mousemove", onMove); window.removeEventListener("mouseup", onUp); };
  }, [box, setBox, snapper]);
  const onDown = (h: string) => { onStart && onStart(); mode.current = { h }; };
  return { onDown };
}

function Handles({ onDown }: { onDown: (h: string) => void }) {
  const base: React.CSSProperties = { position: "absolute", width: 10, height: 10, background: "#ff9d00", border: "2px solid #332d23", borderRadius: 2 };
  return (<>
    <div style={{ ...base, left: -5, top: -5, cursor: "nwse-resize" }} onMouseDown={() => onDown("nw")} />
    <div style={{ ...base, left: "50%", transform: "translateX(-50%)", top: -5, cursor: "ns-resize" }} onMouseDown={() => onDown("n")} />
    <div style={{ ...base, right: -5, top: -5, cursor: "nesw-resize" }} onMouseDown={() => onDown("ne")} />
    <div style={{ ...base, right: -5, top: "50%", transform: "translateY(-50%)", cursor: "ew-resize" }} onMouseDown={() => onDown("e")} />
    <div style={{ ...base, right: -5, bottom: -5, cursor: "nwse-resize" }} onMouseDown={() => onDown("se")} />
    <div style={{ ...base, left: "50%", transform: "translateX(-50%)", bottom: -5, cursor: "ns-resize" }} onMouseDown={() => onDown("s")} />
    <div style={{ ...base, left: -5, bottom: -5, cursor: "nesw-resize" }} onMouseDown={() => onDown("sw")} />
    <div style={{ ...base, left: -5, top: "50%", transform: "translateY(-50%)", cursor: "ew-resize" }} onMouseDown={() => onDown("w")} />
  </>);
}

// Info bar content component
function InfoContent({ config, gameFontFamily }: { config: InfoConfig, gameFontFamily: string }) {
  return (
    <div className="w-full h-full flex items-center justify-between" style={{ fontFamily: gameFontFamily, fontSize: config.font }}>
      {/* Left side: Stage */}
      <div>{config.stageLeft}</div>
      {/* Middle: Chevron (Green) */}
      <div style={{ color: '#77ff99' }}>{config.chevron}</div>
      {/* Right side: Timer & Score */}
      <div className="flex flex-col items-end leading-tight">
        <span>{config.timer}</span>
        <span className="text-[#bfb79f]" style={{ fontSize: config.subFont }}>{config.scoreLabel} {config.score}</span>
      </div>
    </div>
  );
}

// Helper component to wrap all draggable/resizable blocks
function BoxComponent({ id, box, dragHandlers, resizeHandlers, className, openEditor, HudContent, InfoContent, gameFontFamily, infoCfg, configs }: {
  id: keyof typeof configs | 'infobar';
  box: Box;
  dragHandlers: ReturnType<typeof useDrag>;
  resizeHandlers: ReturnType<typeof useResize>;
  className: string;
  openEditor: (id: string) => void;
  HudContent: ({ id, configs }: { id: keyof typeof configs, configs: Record<string, HudConfig> }) => JSX.Element;
  InfoContent: ({ config, gameFontFamily }: { config: InfoConfig, gameFontFamily: string }) => JSX.Element;
  gameFontFamily: string;
  infoCfg: InfoConfig;
  configs: Record<string, HudConfig>;
}) {
  const isEditing = id === 'title' || id === 'infobar' || id === 'crt' || id === 'btnA' || id === 'btnB' || id === 'stick' || id === 'badge' || id === 'life' || id === 'fire' || id === 'sneakers' || id === 'boxes' || id === 'power';

  const content = () => {
    switch (id) {
      case 'title':
        return <div style={{ fontSize: configs.title.font, fontFamily: gameFontFamily }}>{configs.title.label}</div>;
      case 'infobar':
        return <InfoContent config={infoCfg} gameFontFamily={gameFontFamily} />;
      case 'crt':
        return (
          <>
            {/* Scanlines / CRT effect */}
            <div className="absolute inset-0 opacity-20 bg-[linear-gradient(transparent_95%,rgba(255,255,255,.05)_100%)] bg-[size:100%_2px] scan" />
            <HudContent id="crt" configs={configs} />
          </>
        );
      case 'btnA':
        return (
          <>
            <HudContent id="btnA" configs={configs} />
            <div className="pip absolute right-[6px] top-1 w-1.5 h-1.5 rounded-full bg-[#ff9d00]" />
          </>
        );
      case 'btnB':
        return (
          <>
            <HudContent id="btnB" configs={configs} />
            <div className="pip absolute right-[6px] top-1 w-1.5 h-1.5 rounded-full bg-[#ff9d00]" />
          </>
        );
      case 'stick':
        return (
          <>
            <div className="w-[80px] h-[80px] rounded-full bg-[#3a3a3a] border-[2px] border-[#191919] shadow-[inset_0_0_6px_#000] stick" />
            {/* Arrows */}
            <div className="absolute top-1.5 left-1/2 -translate-x-1/2 text-[#777] text-[10px]">‚ñ≤</div>
            <div className="absolute bottom-1.5 left-1/2 -translate-x-1/2 text-[#777] text-[10px]">‚ñº</div>
            <div className="absolute left-1.5 top-1/2 -translate-y-1/2 text-[#777] text-[10px]">‚óÄ</div>
            <div className="absolute right-1.5 top-1/2 -translate-y-1/2 text-[#777] text-[10px]">‚ñ∂</div>
            <HudContent id="stick" configs={configs} />
          </>
        );
      case 'badge':
        return <HudContent id="badge" configs={configs} />;
      case 'life':
      case 'fire':
      case 'sneakers':
      case 'boxes':
      case 'power':
        return <HudContent id={id} configs={configs} />;
      default:
        return null;
    }
  };

  return (
    <div
      className={`absolute ${className} group cursor-move hover:shadow-lg transition-shadow duration-150`}
      style={{ left: box.x, top: box.y, width: box.w, height: box.h, fontFamily: gameFontFamily }}
      onMouseDown={dragHandlers.onMouseDown}
    >
      {/* Edit Overlay (visible on hover or click) */}
      <div
        className="absolute inset-0 border-2 border-dashed border-[#ff9d00] opacity-0 group-hover:opacity-100 transition-opacity duration-150 z-10"
        onDoubleClick={() => openEditor(id)}
      >
        <span className="absolute top-1 left-1 bg-[#ff9d00] text-[#1a1a1a] text-[8px] font-bold px-1 rounded-sm">{id.toUpperCase()}</span>
        {isEditing && (
          <span className="absolute top-1 right-1 bg-[#d47c2e] text-[#1a1a1a] text-[8px] font-bold px-1 rounded-sm cursor-pointer" onClick={(e) => { e.stopPropagation(); openEditor(id); }}>EDIT</span>
        )}
        <Handles onDown={resizeHandlers.onDown} />
      </div>

      {/* Title-specific LEDs */}
      {id === 'title' && (
        <>
          <div className="led absolute top-1 left-1 w-1.5 h-1.5 rounded-full bg-[#ff9d00]" />
          <div className="led absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-[#ff9d00]" />
        </>
      )}

      {/* Content */}
      {content()}
    </div>
  );
}


export default function SneakerQuestRetroV2() {
  // Snap toggle and history stacks
  const [snapOn, setSnapOn] = useState(true);
  const snapper = (n: number) => (snapOn ? hardSnap(n) : n);
  const [past, setPast] = useState<any[]>([]);
  const [future, setFuture] = useState<any[]>([]);

  // Game font selection
  const [gameFont, setGameFont] = useState<'ps2p' | 'vt323' | 'mono'>('ps2p');
  const gameFontFamily = gameFont === 'ps2p' ? '"Press Start 2P", monospace' : gameFont === 'vt323' ? '"VT323", monospace' : 'monospace';

  // Positions and sizes (initialized to original V2)
  const [title, setTitle] = useState<Box>({ x: 8, y: 8, w: 304, h: 32 });
  const [infobar, setInfobar] = useState<Box>({ x: 8, y: 48, w: 304, h: 32 });
  const [crt, setCrt] = useState<Box>({ x: 8, y: 88, w: 304, h: 200 });
  const [life, setLife] = useState<Box>({ x: 8, y: 296, w: 72, h: 40 });
  const [fire, setFire] = useState<Box>({ x: 88, y: 296, w: 72, h: 40 });
  const [sneakers, setSneakers] = useState<Box>({ x: 168, y: 296, w: 72, h: 40 });
  const [boxes, setBoxes] = useState<Box>({ x: 248, y: 296, w: 72, h: 40 });
  const [power, setPower] = useState<Box>({ x: 248, y: 344, w: 64, h: 32 });
  const [btnA, setBtnA] = useState<Box>({ x: 8, y: 480, w: 96, h: 32 });
  const [btnB, setBtnB] = useState<Box>({ x: 8, y: 520, w: 96, h: 32 });
  const [stick, setStick] = useState<Box>({ x: 192, y: 456, w: 120, h: 120 });
  const [badge, setBadge] = useState<Box>({ x: 280, y: 552, w: 32, h: 16 });

  // Editor state for ALL boxes
  const [configs, setConfigs] = useState<Record<string, HudConfig>>({
    // HUD row
    life:     { label: "LIFE", icon: "‚ù§Ô∏è", count: 3, font: 10, iconSize: 12, showCount: false, countText: "", textX: 8, textY: 12, iconX: 44, iconY: 10, countX: 0, countY: 0 },
    fire:     { label: "FIRE", icon: "üî•", count: 1, font: 10, iconSize: 12, showCount: true,  countText: "x 5", textX: 8, textY: 12, iconX: 44, iconY: 10, countX: 60, countY: 12 },
    sneakers: { label: "SNEAKERS", icon: "üëü", count: 5, font: 10, iconSize: 12, showCount: false, countText: "", textX: 8, textY: 12, iconX: 72, iconY: 10, countX: 0, countY: 0 },
    boxes:    { label: "BOX", icon: "üì¶", count: 1, font: 10, iconSize: 12, showCount: true,  countText: "x 0000", textX: 8, textY: 12, iconX: 44, iconY: 10, countX: 60, countY: 12 },
    power:    { label: "", icon: "‚ö°", count: 3, font: 10, iconSize: 12, showCount: false, countText: "", textX: 8, textY: 10, iconX: 20, iconY: 8, countX: 0, countY: 0 },
    // Title plaque
    title:    { label: "SNEAKERQUEST", icon: "", count: 0, font: 14, iconSize: 12, showCount: false, countText: "", textX: 0, textY: 0, iconX: 0, iconY: 0, countX: 0, countY: 0 },
    // CRT pause overlay
    crt:      { label: "II", icon: "", count: 0, font: 24, iconSize: 12, showCount: false, countText: "", textX: 144, textY: 88, iconX: 0, iconY: 0, countX: 0, countY: 0 },
    // Buttons
    btnA:     { label: "JUMP", icon: "", count: 0, font: 12, iconSize: 12, showCount: false, countText: "", textX: 24, textY: 8, iconX: 0, iconY: 0, countX: 0, countY: 0 },
    btnB:     { label: "BOMB", icon: "", count: 0, font: 12, iconSize: 12, showCount: false, countText: "", textX: 28, textY: 8, iconX: 0, iconY: 0, countX: 0, countY: 0 },
    // Joystick label (optional)
    stick:    { label: "", icon: "", count: 0, font: 10, iconSize: 12, showCount: false, countText: "", textX: 0, textY: 0, iconX: 0, iconY: 0, countX: 0, countY: 0 },
    // Badge text
    badge:    { label: "SQ-01", icon: "", count: 0, font: 8,  iconSize: 12, showCount: false, countText: "", textX: 4, textY: 2, iconX: 0, iconY: 0, countX: 0, countY: 0 },
  });

  // Info bar state and draft
  const [infoCfg, setInfoCfg] = useState<InfoConfig>({ stageLeft: "STAGE ‚Äî ONE", chevron: "‚ñ∏", timer: "00:00:00:0", scoreLabel: "SCORE", score: "000000", font: 10, subFont: 9 });
  const [draftInfo, setDraftInfo] = useState<InfoConfig | null>(null);

  const [editId, setEditId] = useState<string | null>(null);
  const [draft, setDraft] = useState<HudConfig | null>(null);

  const openEditor = (id: string) => {
    if (id === 'infobar') { setDraftInfo({ ...infoCfg }); setEditId(id); return; }
    if (!configs[id]) return;
    setDraft({ ...configs[id] });
    setEditId(id);
  };
  const applyEditor = () => {
    if (editId === 'infobar') {
      if (!draftInfo) return;
      setInfoCfg({ ...draftInfo });
      commit();
      setEditId(null);
      setDraftInfo(null);
      return;
    }
    if (!editId || !draft) return;
    setConfigs((c) => ({ ...c, [editId]: { ...draft } }));
    commit();
    setEditId(null);
    setDraft(null);
  };

  // History helpers
  const snapshot = () => ({ title, infobar, crt, life, fire, sneakers, boxes, power, btnA, btnB, stick, badge, configs, infoCfg });
  const applySnapshot = (s: any) => {
    if (!s) return;
    setTitle(s.title); setInfobar(s.infobar); setCrt(s.crt);
    setLife(s.life); setFire(s.fire); setSneakers(s.sneakers); setBoxes(s.boxes); setPower(s.power);
    setBtnA(s.btnA); setBtnB(s.btnB); setStick(s.stick); setBadge(s.badge);
    if (s.configs) setConfigs(s.configs);
    if (s.infoCfg) setInfoCfg(s.infoCfg);
  };
  const commit = () => { setPast((p) => [...p, snapshot()]); setFuture([]); };
  const undo = () => { setPast((p) => { if (p.length === 0) return p; const prev = p[p.length - 1]; setFuture((f) => [snapshot(), ...f]); applySnapshot(prev); return p.slice(0, -1); }); };
  const redo = () => { setFuture((f) => { if (f.length === 0) return f; const next = f[0]; setPast((p) => [...p, snapshot()]); applySnapshot(next); return f.slice(1); }); };

  // Drag hooks (commit history on start)
  const dTitle = useDrag(title, (p) => setTitle((v) => ({ ...v, ...p })), snapper, commit);
  const dInfo = useDrag(infobar, (p) => setInfobar((v) => ({ ...v, ...p })), snapper, commit);
  const dCrt = useDrag(crt, (p) => setCrt((v) => ({ ...v, ...p })), snapper, commit);
  const dLife = useDrag(life, (p) => setLife((v) => ({ ...v, ...p })), snapper, commit);
  const dFire = useDrag(fire, (p) => setFire((v) => ({ ...v, ...p })), snapper, commit);
  const dSnk = useDrag(sneakers, (p) => setSneakers((v) => ({ ...v, ...p })), snapper, commit);
  const dBox = useDrag(boxes, (p) => setBoxes((v) => ({ ...v, ...p })), snapper, commit);
  const dPow = useDrag(power, (p) => setPower((v) => ({ ...v, ...p })), snapper, commit);
  const dA = useDrag(btnA, (p) => setBtnA((v) => ({ ...v, ...p })), snapper, commit);
  const dB = useDrag(btnB, (p) => setBtnB((v) => ({ ...v, ...p })), snapper, commit);
  const dStick = useDrag(stick, (p) => setStick((v) => ({ ...v, ...p })), snapper, commit);
  const dBadge = useDrag(badge, (p) => setBadge((v) => ({ ...v, ...p })), snapper, commit);

  // Resize hooks (commit history on start)
  const rTitle = useResize(title, setTitle, snapper, commit);
  const rInfo = useResize(infobar, setInfobar, snapper, commit);
  const rCrt = useResize(crt, setCrt, snapper, commit);
  const rLife = useResize(life, setLife, snapper, commit);
  const rFire = useResize(fire, setFire, snapper, commit);
  const rSnk = useResize(sneakers, setSneakers, snapper, commit);
  const rBox = useResize(boxes, setBoxes, snapper, commit);
  const rPow = useResize(power, setPower, snapper, commit);
  const rA = useResize(btnA, setBtnA, snapper, commit);
  const rB = useResize(btnB, setBtnB, snapper, commit);
  const rStick = useResize(stick, setStick, snapper, commit);
  const rBadge = useResize(badge, setBadge, snapper, commit);

  // Export/Import state
  const [showExport, setShowExport] = useState(false);
  const [showImport, setShowImport] = useState(false);
  const [importText, setImportText] = useState("");

  // --- Export: Static standalone HTML snapshot ---
  const download = (filename: string, text: string) => {
    const blob = new Blob([text], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  };
  const buildStaticHTML = () => {
    // Helper to style blocks
    const s = (b: Box) => `position:absolute;left:${b.x}px;top:${b.y}px;width:${b.w}px;height:${b.h}px;`;
    const esc = (t: string) => t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const c = (id: keyof typeof configs) => configs[id];
    const iconSeq = (icon: string, n: number) => Array.from({length:n}).map(()=>icon).join('');
    return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SneakerQuest Retro Futuristic v2</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
<style>
  :root{ --bg:#1a1a1a; --beige:#c9bfa6; --bezel:#443f35; --panel:#2e2d29; --ink:#1a1a1a; --text:#d2c7a7 }
  body{ margin:0; background:#1a1a1a; display:flex; align-items:flex-start; justify-content:center; padding:24px; font-family:'Press Start 2P', monospace }
  .device{ position:relative; width:320px; height:576px; border:4px solid var(--bezel); background:var(--beige); border-radius:16px; box-shadow:inset 0 0 0 2px #a09479, 0 4px 0 #2a2a2a }
  .plaque{ background:#d47c2e; color:#1a1a1a; border:2px solid #332d23; border-radius:8px; display:flex; align-items:center; justify-content:center; position:relative; font-weight:700; letter-spacing:2px }
  .led{ position:absolute; top:4px; width:6px; height:6px; border-radius:9999px; background:#ff9d00 }
  .bar{ background:#2e2d29; color:#d2c7a7; border:2px solid #131313; border-radius:6px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; }
  .crt{ background:#1a2b1a; border:3px solid #0a0f0a; border-radius:10px; box-shadow:inset 0 0 20px #0d1b0d; position:relative; overflow:hidden }
  .scan{ position:absolute; inset:0; opacity:.2; background:linear-gradient(transparent 95%, rgba(255,255,255,.05) 100%); background-size:100% 2px }
  .hud{ background:#2e2d29; border:1px solid #131313; border-radius:6px; padding:4px 8px; color:#d2c7a7; position:relative }
  .btn{ background:#2e2d29; border:1px solid #131313; border-radius:12px; position:relative; display:flex; align-items:center; justify-content:center; color:#d2c7a7 }
  .pip{ position:absolute; right:6px; top:4px; width:6px; height:6px; border-radius:9999px; background:#ff9d00 }
  .joystick{ background:#2e2d29; border:2px solid #131313; border-radius:9999px; position:relative; display:flex; align-items:center; justify-content:center; }
  .stick{ width:80px; height:80px; border-radius:9999px; background:#3a3a3a; border:2px solid #191919; box-shadow:inset 0 0 6px #000 }
  .arw{ position:absolute; color:#777; font-size:10px }
  .badge{ color:#2e2d29; font-size:8px; display:flex; align-items:center; justify-content:center }
  .abs{ position:absolute }
</style>
</head>
<body>
  <div class="device">
    <div class="plaque abs" style="${s(title)};font-size:${c('title').font}px">
      ${esc(c('title').label)}
      <div class="led" style="left:4px"></div>
      <div class="led" style="right:4px"></div>
    </div>

    <div class="bar abs" style="${s(infobar)};font-size:${infoCfg.font}px">
      <div>${esc(infoCfg.stageLeft)}</div>
      <div style="color:#77ff99">${esc(infoCfg.chevron)}</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1.1">
        <span>${esc(infoCfg.timer)}</span>
        <span style="color:#bfb79f;font-size:${infoCfg.subFont}px">${esc(infoCfg.scoreLabel)} ${esc(infoCfg.score)}</span>
      </div>
    </div>

    <div class="crt abs" style="${s(crt)}">
      <div class="scan"></div>
      <div class="abs" style="left:${configs.crt.textX}px;top:${configs.crt.textY}px;font-size:${configs.crt.font}px;color:#d2c7a7">${esc(configs.crt.label)}</div>
    </div>

    <div class="hud abs" style="${s(life)}">
      <span style="position:absolute;left:${c('life').textX}px;top:${c('life').textY}px;font-size:${c('life').font}px">${esc(c('life').label)}</span>
      <span style="position:absolute;left:${c('life').iconX}px;top:${c('life').iconY}px;font-size:${c('life').iconSize}px">${iconSeq(c('life').icon,c('life').count)}</span>
    </div>

    <div class="hud abs" style="${s(fire)}">
      <span style="position:absolute;left:${c('fire').textX}px;top:${c('fire').textY}px;font-size:${c('fire').font}px">${esc(c('fire').label)}</span>
      <span style="position:absolute;left:${c('fire').iconX}px;top:${c('fire').iconY}px;font-size:${c('fire').iconSize}px">${iconSeq(c('fire').icon,c('fire').count)}</span>
      <span style="position:absolute;left:${c('fire').countX}px;top:${c('fire').countY}px;font-size:${c('fire').font}px">${esc(c('fire').countText)}</span>
    </div>

    <div class="hud abs" style="${s(sneakers)}">
      <span style="position:absolute;left:${c('sneakers').textX}px;top:${c('sneakers').textY}px;font-size:${c('sneakers').font}px">${esc(c('sneakers').label)}</span>
      <span style="position:absolute;left:${c('sneakers').iconX}px;top:${c('sneakers').iconY}px;font-size:${c('sneakers').iconSize}px">${iconSeq(c('sneakers').icon,c('sneakers').count)}</span>
    </div>

    <div class="hud abs" style="${s(boxes)}">
      <span style="position:absolute;left:${c('boxes').textX}px;top:${c('boxes').textY}px;font-size:${c('boxes').font}px">${esc(c('boxes').label)}</span>
      <span style="position:absolute;left:${c('boxes').iconX}px;top:${c('boxes').iconY}px;font-size:${c('boxes').iconSize}px">${iconSeq(c('boxes').icon,c('boxes').count)}</span>
      <span style="position:absolute;left:${c('boxes').countX}px;top:${c('boxes').countY}px;font-size:${c('boxes').font}px">${esc(c('boxes').countText)}</span>
    </div>

    <div class="hud abs" style="${s(power)}">
      <span style="position:absolute;left:${c('power').iconX}px;top:${c('power').iconY}px;font-size:${c('power').iconSize}px">${iconSeq(c('power').icon,c('power').count)}</span>
    </div>

    <div class="btn abs" style="${s(btnA)};font-size:${c('btnA').font}px">
      ${esc(c('btnA').label)}
      <div class="pip"></div>
    </div>

    <div class="btn abs" style="${s(btnB)};font-size:${c('btnB').font}px">
      <div style="position:absolute;left:${c('btnB').textX}px;top:${c('btnB').textY}px">${esc(c('btnB').label)}</div>
      <div class="pip"></div>
    </div>

    <div class="abs joystick" style="${s(stick)};">
      <div class="stick"></div>
      <div class="arw" style="top:6px;left:50%;transform:translateX(-50%)">‚ñ≤</div>
      <div class="arw" style="bottom:6px;left:50%;transform:translateX(-50%)">‚ñº</div>
      <div class="arw" style="left:6px;top:50%;transform:translateY(-50%)">‚óÄ</div>
      <div class="arw" style="right:6px;top:50%;transform:translateY(-50%)">‚ñ∂</div>
    </div>

    <div class="abs badge" style="${s(badge)};font-size:${c('badge').font}px">${esc(c('badge').label)}</div>
  </div>
</body>
</html>`;
  };
  const exportHTML = () => download('SneakerQuest_Retro_Futuristic_V2.html', buildStaticHTML());

  // JSON helpers (layout only)
  const toJSON = () => ({
    theme: "theme-dmg",
    blocks: [
      { id: "title", ...title }, { id: "infobar", ...infobar }, { id: "crt", ...crt },
      { id: "life", ...life }, { id: "fire", ...fire }, { id: "sneakers", ...sneakers }, { id: "boxes", ...boxes },
      { id: "power", ...power }, { id: "btnA", ...btnA }, { id: "btnB", ...btnB }, { id: "stick", ...stick }, { id: "badge", ...badge },
    ],
  });
  const applyJSON = (obj: any) => {
    if (!obj || !Array.isArray(obj.blocks)) return console.error("Invalid JSON: missing blocks");
    const map: Record<string, any> = {};
    obj.blocks.forEach((b: any) => {
      if (!b?.id) return;
      map[b.id] = { x: snapper(b.x ?? 0), y: snapper(b.y ?? 0), w: Math.max(40, snapper(b.w ?? 40)), h: Math.max(24, snapper(b.h ?? 24)) };
    });
    commit();
    if (map.title) setTitle((v) => ({ ...v, ...map.title }));
    if (map.infobar) setInfobar((v) => ({ ...v, ...map.infobar }));
    if (map.crt) setCrt((v) => ({ ...v, ...map.crt }));
    if (map.life) setLife((v) => ({ ...v, ...map.life }));
    if (map.fire) setFire((v) => ({ ...v, ...map.fire }));
    if (map.sneakers) setSneakers((v) => ({ ...v, ...map.sneakers }));
    if (map.boxes) setBoxes((v) => ({ ...v, ...map.boxes }));
    if (map.power) setPower((v) => ({ ...v, ...map.power }));
    if (map.btnA) setBtnA((v) => ({ ...v, ...map.btnA }));
    if (map.btnB) setBtnB((v) => ({ ...v, ...map.btnB }));
    if (map.stick) setStick((v) => ({ ...v, ...map.stick }));
    if (map.badge) setBadge((v) => ({ ...v, ...map.badge }));
  };

  // Generic HUD content
  const HudContent = ({ id, configs }: { id: keyof typeof configs, configs: Record<string, HudConfig> }) => {
    const c = editId === id && draft ? draft : configs[id];
    if (!c) return null as any;
    const labelColor = (id === 'life' || id === 'fire' || id === 'sneakers' || id === 'boxes' || id === 'power' || id === 'crt') ? '#d2c7a7' : 'inherit';
    return (
      <div className="relative w-full h-full">
        {c.label && (
          <span style={{ position: 'absolute', left: c.textX, top: c.textY, fontFamily: gameFontFamily, fontSize: c.font, color: labelColor }}>{c.label}</span>
        )}
        <span style={{ position: 'absolute', left: c.iconX, top: c.iconY, fontSize: c.iconSize }}>
          {c.count > 0 ? Array.from({ length: c.count }).map((_, i) => <span key={i}>{c.icon}</span>) : null}
        </span>
        {c.showCount && (
          <span style={{ position: 'absolute', left: c.countX, top: c.countY, fontFamily: gameFontFamily, fontSize: c.font, color: labelColor }}>{c.countText}</span>
        )}
      </div>
    );
  };

  // Docked editor panel
  const EditorPanel = () => {
    if (!editId) return null;

    // Info bar editor
    if (editId === 'infobar') {
      if (!draftInfo) return null;
      const setI = (k: keyof InfoConfig, v: any) => setDraftInfo((d) => (d ? { ...d, [k]: v } : d));
      const NumI = ({ label, k, min = 8, max = 16 }: { label: string; k: keyof InfoConfig; min?: number; max?: number }) => (
        <label className="flex items-center justify-between gap-2 text-[#e6e6e6] text-xs md:text-sm font-mono">
          <span className="truncate pr-2">{label}</span>
          <input type="number" className="bg-[#0e0e0e] border border-[#333] rounded px-2 py-1 w-24" value={Number(draftInfo[k] as any)} min={min} max={max} onChange={(e) => setI(k, Number(e.target.value))} />
        </label>
      );
      return (
        <div className="flex flex-col gap-2">
          <div className="text-white text-sm font-mono">Edit: INFO BAR</div>
          <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center gap-2">
            <span className="w-20">Stage</span>
            <input className="flex-1 bg-[#0e0e0e] border border-[#333] rounded px-2 py-1" value={draftInfo.stageLeft} onChange={(e)=>setI('stageLeft', e.target.value)} />
          </label>
          <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center gap-2">
            <span className="w-20">Chevron</span>
            <input className="flex-1 bg-[#0e0e0e] border border-[#333] rounded px-2 py-1" value={draftInfo.chevron} onChange={(e)=>setI('chevron', e.target.value)} />
          </label>
          <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center gap-2">
            <span className="w-20">Timer</span>
            <input className="flex-1 bg-[#0e0e0e] border border-[#333] rounded px-2 py-1" value={draftInfo.timer} onChange={(e)=>setI('timer', e.target.value)} />
          </label>
          <div className="grid grid-cols-2 gap-2">
            <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center gap-2">
              <span className="w-20">Score lbl</span>
              <input className="flex-1 bg-[#0e0e0e] border border-[#333] rounded px-2 py-1" value={draftInfo.scoreLabel} onChange={(e)=>setI('scoreLabel', e.target.value)} />
            </label>
            <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center gap-2">
              <span className="w-16">Score</span>
              <input className="flex-1 bg-[#0e0e0e] border border-[#333] rounded px-2 py-1" value={draftInfo.score} onChange={(e)=>setI('score', e.target.value)} />
            </label>
          </div>
          <div className="grid grid-cols-2 gap-2 pt-2 border-t border-[#333]">
            <NumI label="Font" k="font" min={8} max={14} />
            <NumI label="Sub font" k="subFont" min={8} max={14} />
          </div>
          <div className="flex gap-2 justify-end sticky bottom-0 bg-[#1b1b1b] pt-2">
            <button className="px-2 py-1 bg-[#2e2d29] text-[#d2c7a7] border border-[#131313] rounded" onClick={() => { setEditId(null); setDraftInfo(null); }}>Cancel</button>
            <button className="px-2 py-1 bg-[#ff9d00] text-[#1a1a1a] border border-[#d47c2e] rounded font-bold" onClick={applyEditor}>Apply</button>
          </div>
        </div>
      );
    }

    if (!draft) return null;
    const set = (k: keyof HudConfig, v: any) => setDraft((d) => (d ? { ...d, [k]: v } : d));
    const Num = ({ label, k, min = 0, max = 256 }: { label: string; k: keyof HudConfig; min?: number; max?: number }) => (
      <label className="flex items-center justify-between gap-2 text-[#e6e6e6] text-xs md:text-sm font-mono min-w-0">
        <span className="truncate pr-2">{label}</span>
        <input type="number" className="bg-[#0e0e0e] border border-[#333] rounded px-2 py-1 w-full max-w-[120px]" value={Number(draft[k] as any)} min={min} max={max} onChange={(e) => set(k, Number(e.target.value))} />
      </label>
    );
    return (
      <div className="flex flex-col gap-2 min-w-0">
        <div className="text-white text-sm font-mono">Edit: {editId.toUpperCase()}</div>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center justify-between gap-2 min-w-0">
            <span>Label</span>
            <input className="bg-[#0e0e0e] border border-[#333] rounded px-2 py-1 w-full min-w-0" value={draft.label} onChange={(e) => set("label", e.target.value)} />
          </label>
          <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center justify-between gap-2 min-w-0">
            <span>Icon</span>
            <input className="bg-[#0e0e0e] border border-[#333] rounded px-2 py-1 w-full min-w-0" value={draft.icon} onChange={(e) => set("icon", e.target.value)} />
          </label>
        </div>
        <div className="grid grid-cols-2 gap-2">
          <Num label="Count" k="count" min={0} max={10} />
          <Num label="Font Size (px)" k="font" min={8} max={32} />
          <Num label="Icon Size (px)" k="iconSize" min={8} max={32} />
          {/* This is for elements like Fire/Boxes that track a separate count value */}
          {(editId === 'fire' || editId === 'boxes') && (
            <label className="flex items-center justify-between gap-2 text-[#e6e6e6] text-xs md:text-sm font-mono col-span-2 pt-2 border-t border-[#333]">
              <span className="truncate pr-2">Show Count Text</span>
              <input type="checkbox" className="w-4 h-4 bg-[#0e0e0e] border border-[#333] rounded" checked={draft.showCount} onChange={(e) => set('showCount', e.target.checked)} />
            </label>
          )}
          {(editId === 'fire' || editId === 'boxes') && draft.showCount && (
            <label className="text-[#e6e6e6] text-xs md:text-sm font-mono flex items-center gap-2 col-span-2">
              <span className="w-24">Count Text Value</span>
              <input className="flex-1 bg-[#0e0e0e] border border-[#333] rounded px-2 py-1" value={draft.countText} onChange={(e) => set("countText", e.target.value)} />
            </label>
          )}
        </div>

        <div className="pt-3 border-t border-[#333]">
          <div className="text-[#bfb79f] text-xs mb-1">Absolute Position (X/Y from block top-left)</div>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
            <div className="col-span-1">
              <div className="text-white text-xs mb-1 text-center">Label</div>
              <div className="flex gap-2">
                <Num label="X" k="textX" min={0} max={256} />
                <Num label="Y" k="textY" min={0} max={256} />
              </div>
            </div>
            <div className="col-span-1">
              <div className="text-white text-xs mb-1 text-center">Icon</div>
              <div className="flex gap-2">
                <Num label="X" k="iconX" min={0} max={256} />
                <Num label="Y" k="iconY" min={0} max={256} />
              </div>
            </div>
            {(editId === 'fire' || editId === 'boxes') && draft.showCount && (
              <div className="col-span-2 md:col-span-1">
                <div className="text-white text-xs mb-1 text-center">Count Text</div>
                <div className="flex gap-2">
                  <Num label="X" k="countX" min={0} max={256} />
                  <Num label="Y" k="countY" min={0} max={256} />
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="flex gap-2 justify-end sticky bottom-0 bg-[#1b1b1b] pt-2">
          <button className="px-2 py-1 bg-[#2e2d29] text-[#d2c7a7] border border-[#131313] rounded" onClick={() => { setEditId(null); setDraft(null); }}>Cancel</button>
          <button className="px-2 py-1 bg-[#ff9d00] text-[#1a1a1a] border border-[#d47c2e] rounded font-bold" onClick={applyEditor}>Apply</button>
        </div>
      </div>
    );
  };

  // --- Main Render ---

  // Custom styles for the device and editor panel
  const customStyles = {
    '--bg': '#1a1a1a',
    '--beige': '#c9bfa6',
    '--bezel': '#443f35',
    '--panel': '#2e2d29',
    '--ink': '#1a1a1a',
    '--text': '#d2c7a7',
  };

  return (
    <div className="min-h-screen bg-gray-900 p-4 flex flex-col items-center gap-4" style={customStyles}>
      {/* Control Bar */}
      <div className="w-full max-w-sm bg-[#1b1b1b] p-3 rounded-lg shadow-xl flex flex-col gap-2">
        <div className="flex justify-between items-center gap-2 text-xs font-mono">
          <button
            className={`px-3 py-1 rounded text-white font-bold transition-colors ${past.length > 0 ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-700 cursor-not-allowed'}`}
            onClick={undo} disabled={past.length === 0}
          >
            Undo ({past.length})
          </button>
          <button
            className={`px-3 py-1 rounded text-white font-bold transition-colors ${future.length > 0 ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-700 cursor-not-allowed'}`}
            onClick={redo} disabled={future.length === 0}
          >
            Redo ({future.length})
          </button>
          <button
            className={`px-3 py-1 rounded text-white font-bold transition-colors ${snapOn ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-700 hover:bg-gray-800'}`}
            onClick={() => { setSnapOn(s => !s); commit(); }}
          >
            Snap: {snapOn ? 'ON' : 'OFF'}
          </button>
        </div>
        <div className="flex justify-between items-center gap-2 text-xs font-mono pt-2 border-t border-gray-700">
          <label className="text-white flex items-center gap-2">
            Font:
            <select
              value={gameFont}
              onChange={(e) => setGameFont(e.target.value as 'ps2p' | 'vt323' | 'mono')}
              className="bg-gray-800 text-white rounded p-1"
            >
              <option value="ps2p">Press Start 2P</option>
              <option value="vt323">VT323</option>
              <option value="mono">Monospace</option>
            </select>
          </label>
          <button className="px-3 py-1 rounded bg-blue-600 text-white font-bold hover:bg-blue-700" onClick={exportHTML}>Export HTML</button>
          {/* <button className="px-3 py-1 rounded bg-purple-600 text-white font-bold hover:bg-purple-700" onClick={() => setShowImport(true)}>Import JSON</button> */}
        </div>
      </div>

      {/* Main UI/Editor Layout */}
      <div className="flex gap-4 w-full max-w-5xl">
        {/* Device Container (320px wide) */}
        <div className="device relative w-[320px] h-[576px] border-[4px] border-[var(--bezel)] bg-[var(--beige)] rounded-[16px] shadow-[inset_0_0_0_2px_#a09479,0_4px_0_#2a2a2a] flex-shrink-0">
          {/* Blocks */}
          <BoxComponent id="title" box={title} dragHandlers={dTitle} resizeHandlers={rTitle} className="plaque bg-[#d47c2e] text-[#1a1a1a] border-2 border-[#332d23] rounded-lg flex items-center justify-center font-bold tracking-widest" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="infobar" box={infobar} dragHandlers={dInfo} resizeHandlers={rInfo} className="bar bg-[var(--panel)] text-[var(--text)] border-2 border-[#131313] rounded-md px-3" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="crt" box={crt} dragHandlers={dCrt} resizeHandlers={rCrt} className="crt bg-[#1a2b1a] border-[3px] border-[#0a0f0a] rounded-[10px] shadow-[inset_0_0_20px_#0d1b0d] flex items-center justify-center overflow-hidden" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />

          <BoxComponent id="life" box={life} dragHandlers={dLife} resizeHandlers={rLife} className="hud bg-[var(--panel)] border border-[#131313] rounded-md" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="fire" box={fire} dragHandlers={dFire} resizeHandlers={rFire} className="hud bg-[var(--panel)] border border-[#131313] rounded-md" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="sneakers" box={sneakers} dragHandlers={dSnk} resizeHandlers={rSnk} className="hud bg-[var(--panel)] border border-[#131313] rounded-md" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="boxes" box={boxes} dragHandlers={dBox} resizeHandlers={rBox} className="hud bg-[var(--panel)] border border-[#131313] rounded-md" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="power" box={power} dragHandlers={dPow} resizeHandlers={rPow} className="hud bg-[var(--panel)] border border-[#131313] rounded-md flex items-center justify-center" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />

          <BoxComponent id="btnA" box={btnA} dragHandlers={dA} resizeHandlers={rA} className="btn bg-[var(--panel)] border border-[#131313] rounded-xl flex items-center justify-center font-bold" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="btnB" box={btnB} dragHandlers={dB} resizeHandlers={rB} className="btn bg-[var(--panel)] border border-[#131313] rounded-xl flex items-center justify-center font-bold" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />

          <BoxComponent id="stick" box={stick} dragHandlers={dStick} resizeHandlers={rStick} className="joystick bg-[var(--panel)] border-2 border-[#131313] rounded-full flex items-center justify-center" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
          <BoxComponent id="badge" box={badge} dragHandlers={dBadge} resizeHandlers={rBadge} className="badge bg-[var(--beige)] text-[#2e2d29] flex items-center justify-center" openEditor={openEditor} HudContent={HudContent} InfoContent={InfoContent} gameFontFamily={gameFontFamily} infoCfg={infoCfg} configs={configs} />
        </div>

        {/* Editor Panel (right side) */}
        {editId && (
          <div className="w-full max-w-sm bg-[#1b1b1b] p-4 rounded-lg shadow-xl overflow-y-auto max-h-[576px] sticky top-4">
            <EditorPanel />
          </div>
        )}
      </div>

      {/* Import Modal (simplified as a docked panel for the canvas) */}
      {showImport && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
          <div className="bg-[#1b1b1b] p-6 rounded-lg w-full max-w-md">
            <h2 className="text-xl text-white mb-4">Import Layout (JSON)</h2>
            <textarea
              className="w-full h-40 bg-[#0e0e0e] border border-[#333] rounded p-3 text-white font-mono text-sm resize-none"
              value={importText}
              onChange={(e) => setImportText(e.target.value)}
              placeholder="Paste your exported JSON here..."
            />
            <div className="flex justify-end gap-2 mt-4">
              <button className="px-3 py-1 rounded bg-[#2e2d29] text-[#d2c7a7] border border-[#131313]" onClick={() => setShowImport(false)}>Cancel</button>
              <button className="px-3 py-1 rounded bg-purple-600 text-white font-bold hover:bg-purple-700" onClick={() => {
                try {
                  const obj = JSON.parse(importText);
                  applyJSON(obj);
                  setShowImport(false);
                  setImportText("");
                } catch (e) {
                  console.error("Failed to parse JSON", e);
                  // In a real app, show a user-facing error message here
                }
              }}>Import</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
